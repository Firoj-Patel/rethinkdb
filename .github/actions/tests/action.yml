
name: Test base
description: Base action for running steps

inputs:
  command:
    description: The test runner command to execute.
    required: true
  download_artifacts:
    description: Download and decompress build artifacts.
    default: "true"
    required: false
  test_output_dir:
    description: Directory to store test output (override if needed; otherwise auto-generated per run).
    default: ""
    required: false
  artifact_name:
    description: Name of the build artifact to download (must match the build job upload name).
    default: build-artifacts
    required: false

runs:
  using: composite
  steps:
    - name: install prerequisites
      shell: bash
      run: |
        sudo apt update && \
        sudo apt install -y tar xz-utils curl make git ca-certificates gnupg2 libc6 libcurl4 libprotoc-dev libprotobuf-c-dev libprotobuf-dev protobuf-c-compiler protobuf-compiler

    - name: download build artifacts
      uses: actions/download-artifact@v4
      if: ${{ inputs.download_artifacts == 'true' }}
      with:
        name: ${{ inputs.artifact_name }}

    - name: decompress build dir
      if: ${{ inputs.download_artifacts == 'true' }}
      shell: bash
      run: |
        if [ ! -f build.tar.gz ]; then
          echo "::error::build.tar.gz not found. Ensure the build job uploaded 'build.tar.gz' and the artifact name matches '${{ inputs.artifact_name }}'."
          ls -la
          exit 1
        fi
        # Extract into workspace (relative path avoids leading '/' warnings)
        tar -xzf build.tar.gz -C "${GITHUB_WORKSPACE}"

    - name: prepare test output dir
      shell: bash
      run: |
        if [ -n "${{ inputs.test_output_dir }}" ]; then
          TEST_OUTPUT_DIR="${{ inputs.test_output_dir }}"
        else
          TEST_OUTPUT_DIR="${RUNNER_TEMP:-/tmp}/test-results-${GITHUB_RUN_ID}-${GITHUB_JOB}"
        fi
        rm -rf "${TEST_OUTPUT_DIR}"
        mkdir -p "${TEST_OUTPUT_DIR}"
        echo "TEST_OUTPUT_DIR=${TEST_OUTPUT_DIR}" >> "$GITHUB_ENV"

    - name: run tests
      shell: bash
      env:
        TEST_OUTPUT_DIR: ${{ env.TEST_OUTPUT_DIR }}
      run: ${{ inputs.command }}

    - name: Generate artifact name
      id: generate-name
      shell: bash
      run: echo "artifact=rethinkdb-artifact-${GITHUB_RUN_ID}-$(date +%s)" >> "$GITHUB_OUTPUT"

    - name: compress test artifacts for upload
      if: always()
      shell: bash
      run: |
        ART="${{ steps.generate-name.outputs.artifact }}"
        OUT_DIR="${TEST_OUTPUT_DIR}"
        if [ -z "$OUT_DIR" ]; then
          echo "::error::TEST_OUTPUT_DIR is empty; ensure previous step sets it."
          exit 1
        fi
        # Ensure there's something to package (create placeholder if empty/missing)
        if [ ! -d "$OUT_DIR" ]; then
          echo "::warning::Test output dir '$OUT_DIR' missing; creating empty placeholder."
          mkdir -p "$OUT_DIR"
        fi
        PARENT_DIR="$(dirname "$OUT_DIR")"
        BASE_NAME="$(basename "$OUT_DIR")"
        tar -czf "${ART}.tar.gz" -C "${PARENT_DIR}" "${BASE_NAME}"
        echo "ARTIFACT_TAR=${ART}.tar.gz" >> "$GITHUB_ENV"
               ls -la "${ART}.tar.gz"

    - name: upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.generate-name.outputs.artifact }}
